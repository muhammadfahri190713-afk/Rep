<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DoomsAI</title>
<script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>
<style>
:root {
    --bg-main: #fcf5e5;
    --accent-gold: #8b6b23;
    --text-dark: #5d4617;
    --bold-color: #725a1d;
    --code-bg: #f0e6cc;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body, html { margin:0; padding:0; width:100%; height:100%; background: var(--bg-main); font-family:'Segoe UI',sans-serif; overflow:hidden; }

header { position:fixed; top:0; width:100%; padding:20px 15px; display:flex; justify-content:space-between; align-items:center; z-index:1000; background: var(--bg-main); border-bottom:1px solid rgba(139,107,35,0.1); }
.nav-btn { background:#fff; border:1.5px solid var(--accent-gold); color:var(--accent-gold); border-radius:12px; padding:6px 12px; font-size:13px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px; }
.title-pill { background:#fff; padding:8px 20px; border-radius:20px; border:2.5px solid var(--accent-gold); color:var(--text-dark); font-weight:800; font-size:15px; letter-spacing:0.5px; }

#welcome-text { position:fixed; top:45%; left:50%; transform:translate(-50%,-50%); font-size:24px; font-weight:700; text-align:center; width:85%; color: var(--text-dark); opacity:0.9; transition:0.3s; z-index:5; }
#chat-window { height:100vh; overflow-y:auto; padding:100px 15px 140px; display:flex; flex-direction:column; gap:15px; }

.bubble { max-width:85%; padding:14px 18px; border-radius:22px; font-size:15px; line-height:1.6; color:var(--text-dark); word-wrap:break-word; }
.user { align-self:flex-end; background:#e6d5b0; border-bottom-right-radius:4px; white-space:pre-wrap; }
.ai { align-self:flex-start; background:white; border:1px solid rgba(139,107,35,0.1); border-bottom-left-radius:4px; }

strong,b{ font-weight:800; color:var(--bold-color); }
.code-container{ position:relative; margin:10px 0; background:var(--code-bg); border-radius:12px; overflow:hidden; border:1.5px solid rgba(139,107,35,0.2);}
.copy-btn{ position:absolute; top:8px; right:8px; background:var(--accent-gold); border:none; color:#fff; padding:5px 10px; font-size:11px; border-radius:6px; cursor:pointer; z-index:100; transition:0.2s; font-weight:bold;}
.copy-btn:active{transform:scale(0.9);}
pre{margin:0; padding:45px 15px 15px; color:var(--text-dark); overflow-x:auto; font-family:'Consolas', monospace; font-size:13px; white-space:pre;}

.input-container{ position:fixed; bottom:30px; width:100%; display:flex; justify-content:center; padding:0 15px; z-index:1000; }
.input-wrapper{ width:100%; max-width:600px; background:white; border:2.5px solid var(--accent-gold); border-radius:40px; display:flex; align-items:center; padding:6px 10px 6px 20px; box-shadow:0 8px 25px rgba(139,107,35,0.15);}
input{flex:1; background:none; border:none; color:var(--text-dark); font-size:16px; outline:none;}
#action-btn{ background:var(--accent-gold); border:none; border-radius:50%; width:42px; height:42px; display:flex; align-items:center; justify-content:center; cursor:pointer;}

/* Modal */
#modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:2000; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px);}
.modal-content{ background:white; width:100%; max-width:380px; padding:25px; border-radius:20px; border:2px solid var(--accent-gold);}

/* TYPING DOTS 1 BARIS NORMAL */
.typing-dots{ display:inline-flex; gap:5px; height:18px; align-items:center; }
.typing-dots span{ display:inline-block; width:6px; height:6px; background:#725a1d; border-radius:50%; animation:blink 1.4s infinite both; }
.typing-dots span:nth-child(1){animation-delay:0s;}
.typing-dots span:nth-child(2){animation-delay:0.2s;}
.typing-dots span:nth-child(3){animation-delay:0.4s;}

@keyframes blink{ 0%,80%,100%{opacity:0;} 40%{opacity:1;} }
</style>
</head>
<body>

<header>
<button class="nav-btn" onclick="openModal()"><i data-lucide="settings-2" style="width:18px"></i> Prompt</button>
<div class="title-pill">DoomsAI</div>
<button class="nav-btn" onclick="resetChat()"><i data-lucide="refresh-cw" style="width:18px"></i> Reset</button>
</header>

<div id="welcome-text">Apa yang bisa saya bantu?</div>
<div id="chat-window"></div>

<div class="input-container">
<div class="input-wrapper">
<input type="text" id="user-input" placeholder="Tanya sesuatu ke DoomsAI..." autocomplete="off">
<button id="action-btn" onclick="handleChat()"><i id="btn-icon" data-lucide="arrow-up" style="color:white; width:22px; stroke-width:3.5px;"></i></button>
</div>
</div>

<div id="modal">
<div class="modal-content">
<h3>Custom Prompt</h3>
<textarea id="sys-prompt" style="width:100%; height:100px; border-radius:12px; padding:10px;"></textarea>
<button onclick="closeModal()" style="width:100%; margin-top:10px; background:var(--accent-gold); color:white; border:none; padding:10px; border-radius:10px;">Simpan</button>
</div>
</div>

<script>
const API_KEY="AIzaSyCGwj28mE0mB4ZmZXx9OQUTkZqDDTwGWqY";
const MODEL="gemini-2.5-flash";
let history=[],isTyping=false,controller;

async function handleChat(){
    if(isTyping){controller.abort(); setUI(false); return;}
    const input=document.getElementById('user-input');
    const text=input.value.trim(); if(!text) return;

    document.getElementById('welcome-text').style.opacity="0";
    setTimeout(()=>{document.getElementById('welcome-text').style.display="none";},300);

    addBubble(text,'user');
    history.push({role:"user",parts:[{text}]});
    input.value="";

    setUI(true);
    const aiBubble=addBubble('','ai');
    controller=new AbortController();

    try{
        const sys=document.getElementById('sys-prompt').value||"Kamu adalah DoomsAI. Santai aja, pakai Markdown tebal (**teks**) dan simbol asli. Jangan bahasa baku.";
        const response=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:streamGenerateContent?key=${API_KEY}`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({contents:history,systemInstruction:{parts:[{text:sys}]} }),
            signal:controller.signal
        });

        const reader=response.body.getReader();
        let fullText="";

        while(true){
            const {done,value}=await reader.read();
            if(done) break;
            const chunk=new TextDecoder().decode(value);
            const lines=chunk.split("\n");
            for(let line of lines){
                if(line.includes('"text":')){
                    const match=line.match(/"text":\s*"(.*)"/);
                    if(match){
                        let clean=match[1].replace(/\\n/g,"\n").replace(/\\"/g,'"').replace(/\\\\/g,'\\').replace(/\\u003c/g,'<').replace(/\\u003e/g,'>');
                        fullText+=clean;
                        aiBubble.innerHTML=parseMarkdown(fullText);
                        document.getElementById('chat-window').scrollTop=999999;
                    }
                }
            }
        }
        history.push({role:"model",parts:[{text:fullText}]});
    }catch(e){if(e.name!=='AbortError') aiBubble.innerText="Error API.";} finally{setUI(false);}
}

function parseMarkdown(text){
    text=text.replace(/```(?:html|javascript|css|code|json)?([\s\S]*?)```/g,(m,code)=>{
        let escaped=code.replace(/</g,"&lt;").replace(/>/g,"&gt;").trim();
        return `<div class="code-container"><button class="copy-btn" onclick="copyToClipboard(this)">Salin</button><pre><code>${escaped}</code></pre></div>`;
    });
    text=text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,"<br>");
    return text;
}

function copyToClipboard(btn){
    const code=btn.parentElement.querySelector('code').innerText;
    navigator.clipboard.writeText(code).then(()=>{
        const old=btn.innerText;
        btn.innerText="Berhasil!";
        setTimeout(()=>{btn.innerText=old;},2000);
    });
}

function addBubble(txt,type){
    const b=document.createElement('div'); b.className=`bubble ${type}`;
    if(type==='user'){b.textContent=txt;}
    else{
        if(txt===''){b.innerHTML=`<div class="typing-dots"><span></span><span></span><span></span></div>`;}
        else{b.innerHTML=txt;}
    }
    document.getElementById('chat-window').appendChild(b);
    document.getElementById('chat-window').scrollTop=999999;
    return b;
}

function setUI(typing){
    isTyping=typing;
    const btn=document.getElementById('action-btn');
    btn.innerHTML=typing?'<i data-lucide="square" style="color:white;width:20px;"></i>':'<i data-lucide="arrow-up" style="color:white;width:22px;stroke-width:3.5px;"></i>';
    btn.style.background=typing?"#9b2c2c":"var(--accent-gold)";
    lucide.createIcons();
}

function resetChat(){if(controller) controller.abort(); document.getElementById('chat-window').innerHTML=""; const welcome=document.getElementById('welcome-text'); welcome.style.display="block"; welcome.style.opacity="0.9"; history=[]; setUI(false);}
function openModal(){document.getElementById('modal').style.display='flex';}
function closeModal(){document.getElementById('modal').style.display='none';}

document.getElementById('user-input').onkeypress=(e)=>{if(e.key==="Enter") handleChat();}
lucide.createIcons();
</script>
</body>
</html>